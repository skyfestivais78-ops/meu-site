<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sorteio personalizado</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üé≤</text></svg>">
  <style>
    /* (mantive os estilos originais, sem altera√ß√µes funcionais) */
    :root {
      --primary-color: #2563eb;
      --primary-hover: #1d4ed8;
      --secondary-bg: #e0f2fe;
      --secondary-color: #1e40af;
      --secondary-hover: #bae6fd;
      --reset-bg: #fef2f2;
      --reset-color: #dc2626;
      --reset-hover: #fee2e2;
      --card-bg: white;
      --text-color: #111827;
      --background: #f1f5f9;
      --border-color: #cbd5e1;
      --highlight-color: #dc2626;
      --fixed-bg: #ffedd5;
      --fixed-border: #fdba74;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--background); color: var(--text-color); margin: 0; padding: 1rem; }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 { text-align: center; font-size: 1.9rem; color: var(--primary-color); margin-bottom: 1rem; }
    .card { background: var(--card-bg); border-radius: 14px; padding: 1.2rem; margin: 1rem auto; box-shadow: 0 4px 12px rgba(0,0,0,0.08); width: 100%; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 0.6rem; }
    label { display: block; margin: 0.8rem 0 0.3rem; font-weight: 500; }
    input, select { padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; width: 100%; font-size: 1rem; }
    button { padding: 0.8rem 1.5rem; border-radius: 10px; cursor: pointer; margin: 0.3rem; border: none; font-weight: bold; transition: all .2s; font-size: 1rem; }
    button.primary { background: var(--primary-color); color: white; }
    button.primary:hover { background: var(--primary-hover); }
    button.secondary { background: var(--secondary-bg); color: var(--secondary-color); }
    button.secondary:hover { background: var(--secondary-hover); }
    button.reset { background: var(--reset-bg); color: var(--reset-color); }
    button.reset:hover { background: var(--reset-hover); }
    .freq { border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.6rem; text-align: center; font-size: 0.9rem; background: #f9fafb; }
    .bar { height: 8px; background: var(--primary-color); border-radius: 4px; margin-top: 6px; transition: width 0.3s; }
    .ranking { max-height: 200px; overflow-y: auto; padding-left: 1.2rem; }
    .status { font-size: 0.95rem; color: #374151; margin: 0.5rem; display: inline-block; }
    .lastNumber { font-size: 3.5rem; font-weight: bold; color: #1e3a8a; margin: 1rem 0; }
    .highlight { color: var(--highlight-color); font-weight: bold; }
    .section-title { margin-top: 2rem; border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; color: var(--primary-color); font-size: 1.5rem; }
    .numbers-display { font-size: 1.2rem; text-align: center; padding: 1rem; background: #f0f9ff; border-radius: 10px; margin: 1rem 0; }
    .numbers-display span { display: inline-block; padding: 0.5rem; margin: 0.2rem; background: #dbeafe; border-radius: 6px; min-width: 40px; }
    .button-group { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; margin: 1rem 0; }
    .explanation { font-size: 0.9rem; color: #64748b; margin-top: 0.5rem; font-style: italic; }
    .fixed-number { background-color: var(--fixed-bg) !important; border: 1px solid var(--fixed-border) !important; }
    .clover-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 1rem; margin: 1rem 0; }
    .clover { position: relative; width: 60px; height: 60px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .clover:before { content: "üçÄ"; position: absolute; font-size: 40px; z-index: 0; }
    .clover span { position: relative; z-index: 1; }
    .clover.selected { background: #059669; transform: scale(1.1); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    .clover.selected:before { content: "‚úÖ"; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .modal-content { background: white; margin: 15% auto; padding: 20px; border-radius: 10px; max-width: 400px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .modal-close { background: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 15px; }
    @media (max-width: 768px) {
      body { padding: 0.5rem; }
      h1 { font-size: 1.6rem; }
      .card { padding: 1rem; margin: 0.8rem auto; border-radius: 12px; }
      .button-group { flex-direction: column; }
      button { width: 100%; margin: 0.3rem 0; }
      .lastNumber { font-size: 2.8rem; }
      .grid { grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 0.4rem; }
      .section-title { font-size: 1.3rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé≤ Sorteio Personalizado (corrigido)</h1>
    <!-- (Conte√∫do HTML mantido igual; ids e estrutura originais preservadas) -->

    <div class="card">
      <h3>‚öôÔ∏è Configura√ß√µes</h3>
      <label>De: <input id="minVal" type="number" value="1"></label>
      <label>At√©: <input id="maxVal" type="number" value="31"></label>
      <label>Meu n√∫mero escolhido: <input id="chosenNumber" type="number" placeholder="Nenhum"></label>
      <label>Quantos n√∫meros mais repetidos mostrar: <input id="topCount" type="number" value="7" min="1"></label>
      <label>N√∫meros fixos (separados por ;): <input id="fixedNumbers" type="text" placeholder="Ex: 17;48;45"></label>
      <label>Erro relativo (Œµ): <input id="epsilon" type="number" step="0.01" min="0.02" max="0.5" value="0.2"></label>
      <label>Confian√ßa (1‚àíŒ¥): <input id="confidence" type="number" step="0.01" min="0.5" max="0.999" value="0.95"></label>
      <label>Cliques recomendados N: <input id="recommendedN" type="number" value="90" min="10"></label>
      <div class="explanation">O c√°lculo considera o intervalo (De-At√©) e a quantidade de n√∫meros mais repetidos a serem mostrados.</div>
    </div>

    <div class="card" style="text-align:center;">
      <div class="button-group">
        <button id="drawBtn" class="primary">Sortear</button>
        <button id="autoBtn" class="secondary">Auto at√© N</button>
        <button id="stopAutoBtn" class="reset" style="display:none;">Parar Auto</button>
        <button id="resetBtn" class="reset">Reset</button>
      </div>
      <span class="status">Cliques: <b id="clicks">0</b></span>
      <span class="status" id="status"></span>
    </div>

    <div class="card">
      <h3>üìä Frequ√™ncias observadas</h3>
      <div id="freqGrid" class="grid"></div>
    </div>

    <div class="card">
      <h3>üèÜ Mais frequentes (por frequ√™ncia)</h3>
      <ol id="ranking" class="ranking"></ol>
    </div>

    <div class="card">
      <h3>üî¢ Sequ√™ncia dos Mais Sorteados (ordem num√©rica)</h3>
      <div id="numbersDisplay" class="numbers-display">-</div>
    </div>

    <div class="card" style="text-align:center;">
      <div>√öltimo n√∫mero sorteado:</div>
      <div id="lastNumber" class="lastNumber">-</div>
    </div>

    <h2 class="section-title">Sorteio de Meses</h2>

    <div class="card">
      <h3>‚öôÔ∏è Configura√ß√µes de Meses</h3>
      <label>Quantos meses mais repetidos mostrar: <input id="topMonthsCount" type="number" value="1" min="1" max="12"></label>
      <label>Meu m√™s escolhido: 
        <select id="chosenMonth">
          <option value="-1">Nenhum m√™s</option>
          <option value="0">Janeiro</option>
          <option value="1">Fevereiro</option>
          <option value="2">Mar√ßo</option>
          <option value="3">Abril</option>
          <option value="4">Maio</option>
          <option value="5">Junho</option>
          <option value="6">Julho</option>
          <option value="7">Agosto</option>
          <option value="8">Setembro</option>
          <option value="9">Outubro</option>
          <option value="10">Novembro</option>
          <option value="11">Dezembro</option>
        </select>
      </label>
      <label>Erro relativo (Œµ): <input id="monthEpsilon" type="number" step="0.01" min="0.02" max="0.5" value="0.2"></label>
      <label>Confian√ßa (1‚àíŒ¥): <input id="monthConfidence" type="number" step="0.01" min="0.5" max="0.999" value="0.95"></label>
      <label>Cliques recomendados N: <input id="monthRecommendedN" type="number" value="100" min="10"></label>
      <div class="explanation">O c√°lculo considera a quantidade de meses a serem selecionados.</div>
    </div>

    <div class="card" style="text-align:center;">
      <div class="button-group">
        <button id="drawMonthBtn" class="primary">Sortear M√™s</button>
        <button id="autoMonthBtn" class="secondary">Auto Meses at√© N</button>
        <button id="stopAutoMonthBtn" class="reset" style="display:none;">Parar Auto</button>
        <button id="resetMonthBtn" class="reset">Reset Meses</button>
      </div>
      <span class="status">Sorteios de meses: <b id="monthClicks">0</b></span>
      <span class="status" id="monthStatus"></span>
    </div>

    <div class="card">
      <h3>üìä Frequ√™ncias de Meses</h3>
      <div id="monthFreqGrid" class="grid"></div>
    </div>

    <div class="card">
      <h3>üèÜ Meses Mais Frequentes</h3>
      <ol id="monthRanking" class="ranking"></ol>
    </div>

    <h2 class="section-title">Sorteio de Trevos da Sorte</h2>

    <div class="card">
      <h3>‚öôÔ∏è Configura√ß√µes de Trevos</h3>
      <label>Meu trevo escolhido: 
        <select id="chosenClover">
          <option value="-1">Nenhum trevo</option>
          <option value="0">Trevo 1</option>
          <option value="1">Trevo 2</option>
          <option value="2">Trevo 3</option>
          <option value="3">Trevo 4</option>
          <option value="4">Trevo 5</option>
          <option value="5">Trevo 6</option>
          <option value="6">Trevo 7</option>
        </select>
      </label>
      <label>Quantos trevos mais sorteados mostrar: <input id="topCloversCount" type="number" value="2" min="1" max="7"></label>
      <label>Erro relativo (Œµ): <input id="cloverEpsilon" type="number" step="0.01" min="0.02" max="0.5" value="0.2"></label>
      <label>Confian√ßa (1‚àíŒ¥): <input id="cloverConfidence" type="number" step="0.01" min="0.5" max="0.999" value="0.95"></label>
      <label>Cliques recomendados N: <input id="cloverRecommendedN" type="number" value="100" min="10"></label>
      <div class="explanation">Ser√£o sorteados 2 trevos em cada clique. O c√°lculo considera a quantidade de trevos a serem selecionados.</div>
    </div>

    <div class="card">
      <h3>üçÄ Trevos da Sorte</h3>
      <div class="clover-container">
        <div class="clover" data-id="0"><span>1</span></div>
        <div class="clover" data-id="1"><span>2</span></div>
        <div class="clover" data-id="2"><span>3</span></div>
        <div class="clover" data-id="3"><span>4</span></div>
        <div class="clover" data-id="4"><span>5</span></div>
        <div class="clover" data-id="5"><span>6</span></div>
        <div class="clover" data-id="6"><span>7</span></div>
      </div>
    </div>

    <div class="card" style="text-align:center;">
      <div class="button-group">
        <button id="drawCloverBtn" class="primary">Sortear 2 Trevos</button>
        <button id="autoCloverBtn" class="secondary">Auto at√© N</button>
        <button id="stopAutoCloverBtn" class="reset" style="display:none;">Parar Auto</button>
        <button id="resetCloverBtn" class="reset">Reset Trevos</button>
      </div>
      <span class="status">Cliques: <b id="cloverClicks">0</b></span>
      <span class="status" id="cloverStatus"></span>
    </div>

    <div class="card">
      <h3>üìä Frequ√™ncias de Trevos</h3>
      <div id="cloverFreqGrid" class="grid"></div>
    </div>

    <div class="card">
      <h3>üèÜ Trevos Mais Sorteados</h3>
      <ol id="cloverRanking" class="ranking"></ol>
    </div>
  </div>

  <!-- Modal de Erro -->
  <div id="errorModal" class="modal">
    <div class="modal-content">
      <h3>Erro de Configura√ß√£o</h3>
      <p id="errorMessage">Voc√™ especificou mais n√∫meros fixos do que a quantidade de n√∫meros a serem mostrados.</p>
      <button id="modalCloseBtn" class="modal-close">Fechar</button>
    </div>
  </div>

  <script>
    // Vari√°veis globais
    let counts = [];
    let monthCounts = Array(12).fill(0);
    let cloverCounts = Array(7).fill(0);
    let clicks = 0;
    let monthClicks = 0;
    let cloverClicks = 0;
    let autoMode = false;
    let monthAutoMode = false;
    let cloverAutoMode = false;

    // Web Workers para execu√ß√£o em segundo plano
    let numberWorker = null;
    let monthWorker = null;
    let cloverWorker = null;

    // Elementos do DOM
    const minValInput = document.getElementById('minVal');
    const maxValInput = document.getElementById('maxVal');
    const chosenNumberInput = document.getElementById('chosenNumber');
    const topCountInput = document.getElementById('topCount');
    const fixedNumbersInput = document.getElementById('fixedNumbers');
    const epsilonInput = document.getElementById('epsilon');
    const confidenceInput = document.getElementById('confidence');
    const recommendedNInput = document.getElementById('recommendedN');
    const clicksSpan = document.getElementById('clicks');
    const statusSpan = document.getElementById('status');
    const freqGrid = document.getElementById('freqGrid');
    const rankingOl = document.getElementById('ranking');
    const numbersDisplayDiv = document.getElementById('numbersDisplay');
    const lastNumberDiv = document.getElementById('lastNumber');
    const drawBtn = document.getElementById('drawBtn');
    const autoBtn = document.getElementById('autoBtn');
    const stopAutoBtn = document.getElementById('stopAutoBtn');
    const resetBtn = document.getElementById('resetBtn');

    // Elementos para meses (atualizados)
    const topMonthsCountInput = document.getElementById('topMonthsCount');
    const chosenMonthSelect = document.getElementById('chosenMonth');
    const monthEpsilonInput = document.getElementById('monthEpsilon');
    const monthConfidenceInput = document.getElementById('monthConfidence');
    const monthRecommendedNInput = document.getElementById('monthRecommendedN');
    const monthClicksSpan = document.getElementById('monthClicks');
    const monthStatusSpan = document.getElementById('monthStatus');
    const monthFreqGrid = document.getElementById('monthFreqGrid');
    const monthRankingOl = document.getElementById('monthRanking');
    const drawMonthBtn = document.getElementById('drawMonthBtn');
    const autoMonthBtn = document.getElementById('autoMonthBtn');
    const stopAutoMonthBtn = document.getElementById('stopAutoMonthBtn');
    const resetMonthBtn = document.getElementById('resetMonthBtn');

    // Elementos para trevos
    const chosenCloverSelect = document.getElementById('chosenClover');
    const topCloversCountInput = document.getElementById('topCloversCount');
    const cloverEpsilonInput = document.getElementById('cloverEpsilon');
    const cloverConfidenceInput = document.getElementById('cloverConfidence');
    const cloverRecommendedNInput = document.getElementById('cloverRecommendedN');
    const cloverClicksSpan = document.getElementById('cloverClicks');
    const cloverStatusSpan = document.getElementById('cloverStatus');
    const cloverFreqGrid = document.getElementById('cloverFreqGrid');
    const cloverRankingOl = document.getElementById('cloverRanking');
    const drawCloverBtn = document.getElementById('drawCloverBtn');
    const autoCloverBtn = document.getElementById('autoCloverBtn');
    const stopAutoCloverBtn = document.getElementById('stopAutoCloverBtn');
    const resetCloverBtn = document.getElementById('resetCloverBtn');
    const cloverElements = document.querySelectorAll('.clover');
    const errorModal = document.getElementById('errorModal');
    const errorMessage = document.getElementById('errorMessage');
    const modalCloseBtn = document.getElementById('modalCloseBtn');

    const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                       "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    const cloverNames = ["Trevo 1", "Trevo 2", "Trevo 3", "Trevo 4", "Trevo 5", "Trevo 6", "Trevo 7"];

    function getRange() {
      let min = parseInt(minValInput.value);
      let max = parseInt(maxValInput.value);
      if (isNaN(min)) min = 1;
      if (isNaN(max)) max = 1;
      if (max < min) { const tmp = min; min = max; max = tmp; }
      return {min, max, k: max - min + 1};
    }

    function getFixedNumbers() {
      const fixedNumbersText = fixedNumbersInput.value.trim();
      if (!fixedNumbersText) return [];
      const numbers = fixedNumbersText.split(';').map(num => parseInt(num.trim())).filter(num => !isNaN(num));
      return Array.from(new Set(numbers)).sort((a,b)=>a-b);
    }

    function validateFixedNumbers() {
      const fixedNumbers = getFixedNumbers();
      const topCount = parseInt(topCountInput.value) || 1;
      const {min, max, k} = getRange();

      if (fixedNumbers.length > topCount) {
        errorMessage.textContent = `Voc√™ especificou ${fixedNumbers.length} n√∫meros fixos, mas s√≥ quer mostrar ${topCount} n√∫meros.`;
        showErrorModal();
        return false;
      }

      const outOfRange = fixedNumbers.filter(num => num < min || num > max);
      if (outOfRange.length > 0) {
        errorMessage.textContent = `Os seguintes n√∫meros est√£o fora do intervalo [${min}, ${max}]: ${outOfRange.join(', ')}`;
        showErrorModal();
        return false;
      }

      if (fixedNumbers.length >= k) {
        errorMessage.textContent = `Voc√™ fixou todos (ou mais) os n√∫meros do intervalo; n√£o h√° n√∫meros para sortear.`;
        showErrorModal();
        return false;
      }

      return true;
    }

    function showErrorModal() { errorModal.style.display = 'block'; }
    function hideErrorModal() { errorModal.style.display = 'none'; }
    modalCloseBtn.onclick = hideErrorModal;
    errorModal.addEventListener('click', (e)=> { if (e.target === errorModal) hideErrorModal(); });

    function calcRecommendedN() {
      if (!validateFixedNumbers()) return 0;
      const {k} = getRange();
      const topCount = parseInt(topCountInput.value) || 1;
      const fixedNumbers = getFixedNumbers();
      const eps = Math.max(0.02, Math.min(0.5, Number(epsilonInput.value) || 0.2));
      const conf = Math.max(0.5, Math.min(0.999, Number(confidenceInput.value) || 0.95));
      const delta = 1 - conf;
      const effectiveK = Math.max(1, k - fixedNumbers.length);
      const baseN = (1 / (2 * eps * eps)) * Math.log((2 * effectiveK) / delta);
      const adjustmentFactor = 1 + (Math.log(Math.max(1, topCount - fixedNumbers.length)) / Math.log(2)) * 0.5;
      return Math.ceil(baseN * adjustmentFactor);
    }

    function calcMonthRecommendedN() {
      const topMonthsCount = parseInt(topMonthsCountInput.value) || 1;
      const eps = Math.max(0.02, Math.min(0.5, Number(monthEpsilonInput.value) || 0.2));
      const conf = Math.max(0.5, Math.min(0.999, Number(monthConfidenceInput.value) || 0.95));
      const delta = 1 - conf;
      const k = 12;
      const baseN = (1 / (2 * eps * eps)) * Math.log((2 * k) / delta);
      const adjustmentFactor = 1 + (Math.log(Math.max(1, topMonthsCount)) / Math.log(2)) * 0.5;
      return Math.ceil(baseN * adjustmentFactor);
    }

    function calcCloverRecommendedN() {
      const topCloversCount = parseInt(topCloversCountInput.value) || 1;
      const eps = Math.max(0.02, Math.min(0.5, Number(cloverEpsilonInput.value) || 0.2));
      const conf = Math.max(0.5, Math.min(0.999, Number(cloverConfidenceInput.value) || 0.95));
      const delta = 1 - conf;
      const k = 7;
      const baseN = (1 / (2 * eps * eps)) * Math.log((2 * k) / delta);
      const adjustmentFactor = 1 + (Math.log(Math.max(1, topCloversCount * 2)) / Math.log(2)) * 0.7;
      return Math.ceil(baseN * adjustmentFactor);
    }

    function updateRecommendedN() {
      const val = calcRecommendedN();
      if (val === 0) return;
      recommendedNInput.value = val;
    }
    function updateMonthRecommendedN() { monthRecommendedNInput.value = calcMonthRecommendedN(); }
    function updateCloverRecommendedN() { cloverRecommendedNInput.value = calcCloverRecommendedN(); }

    function initCountsIfNeeded() {
      const {k} = getRange();
      if (!counts || counts.length !== k) { counts = Array(k).fill(0); }
    }

    function resetCounts() { const {k} = getRange(); counts = Array(k).fill(0); clicks = 0; updateUI(); }
    function resetMonthCounts() { monthCounts = Array(12).fill(0); monthClicks = 0; updateMonthUI(); }
    function resetCloverCounts() { cloverCounts = Array(7).fill(0); cloverClicks = 0; cloverElements.forEach(clover => clover.classList.remove('selected')); updateCloverUI(); }

    function updateUI() {
      const {min, max, k} = getRange();
      initCountsIfNeeded();
      const chosen = parseInt(chosenNumberInput.value);
      const topCount = parseInt(topCountInput.value) || 1;
      const fixedNumbers = getFixedNumbers();
      const N = parseInt(recommendedNInput.value) || 0;
      clicksSpan.textContent = clicks;
      statusSpan.textContent = N > 0 ? (clicks >= N ? '‚úÖ Amostragem suficiente' : '‚û°Ô∏è Continue at√© N') : '';

      const maxCount = Math.max(1, ...counts);
      freqGrid.innerHTML = '';
      counts.forEach((c, idx) => {
        const val = min + idx;
        const div = document.createElement('div');
        div.className = 'freq';
        if (fixedNumbers.includes(val)) div.classList.add('fixed-number');
        div.innerHTML = `<div><b ${val===chosen ? 'class="highlight"' : ''}>${val}</b></div><div>${c}</div>`;
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.width = (c / maxCount * 100) + '%';
        div.appendChild(bar);
        freqGrid.appendChild(div);
      });

      const ranking = counts.map((c, idx) => ({n: min+idx, c})).sort((a,b)=> b.c - a.c || a.n - b.n);
      rankingOl.innerHTML = '';
      let finalRanking = [];
      const fixedNumbersList = getFixedNumbers();
      for (const fixedNum of fixedNumbersList) {
        const fixedItem = ranking.find(item => item.n === fixedNum);
        if (fixedItem) finalRanking.push(fixedItem);
      }
      for (const item of ranking) { if (finalRanking.length >= topCount) break; if (!fixedNumbersList.includes(item.n)) finalRanking.push(item); }
      finalRanking.sort((a,b)=> b.c - a.c || a.n - b.n);
      finalRanking.forEach((r, idx) => {
        const li = document.createElement('li');
        const isFixed = fixedNumbersList.includes(r.n);
        li.textContent = `${idx+1}. N√∫mero ${r.n} ‚Üí ${r.c} vezes ${isFixed ? '(fixo)' : ''}`;
        if(r.n === chosen) li.className = "highlight";
        if(isFixed) li.style.fontWeight = "bold";
        rankingOl.appendChild(li);
      });

      updateNumbersDisplay(finalRanking);
    }

    function updateNumbersDisplay(topRanking) {
      if (!topRanking || topRanking.length === 0) { numbersDisplayDiv.textContent = "-"; return; }
      const sortedByNumber = [...topRanking].sort((a,b)=> a.n - b.n);
      const fixedNumbers = getFixedNumbers();
      numbersDisplayDiv.innerHTML = "";
      sortedByNumber.forEach((item, index) => {
        const span = document.createElement('span');
        span.textContent = item.n.toString().padStart(2, '0');
        if (item.n === parseInt(chosenNumberInput.value)) { span.style.background = '#fee2e2'; span.style.color = '#dc2626'; span.style.fontWeight = 'bold'; }
        if (fixedNumbers.includes(item.n)) { span.style.background = '#ffedd5'; span.style.border = '1px solid #fdba74'; }
        numbersDisplayDiv.appendChild(span);
        if (index < sortedByNumber.length - 1) {
          const arrow = document.createElement('span');
          arrow.textContent = " ‚Üí ";
          arrow.style.background = 'none';
          numbersDisplayDiv.appendChild(arrow);
        }
      });
    }

    function updateMonthUI() {
      const topMonthsCount = parseInt(topMonthsCountInput.value) || 1;
      const chosenMonth = parseInt(chosenMonthSelect.value);
      const N = parseInt(monthRecommendedNInput.value) || 0;
      monthClicksSpan.textContent = monthClicks;
      monthStatusSpan.textContent = N > 0 ? (monthClicks >= N ? '‚úÖ Amostragem suficiente' : '‚û°Ô∏è Continue at√© N') : '';

      const maxMonthCount = Math.max(1, ...monthCounts);
      monthFreqGrid.innerHTML = '';
      monthCounts.forEach((c, idx) => {
        const div = document.createElement('div');
        div.className = 'freq';
        const highlight = chosenMonth === -1 ? false : idx == chosenMonth;
        div.innerHTML = `<div><b ${highlight ? 'class="highlight"' : ''}>${monthNames[idx]}</b></div><div>${c}</div>`;
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.width = (c / maxMonthCount * 100) + '%';
        div.appendChild(bar);
        monthFreqGrid.appendChild(div);
      });

      const monthRanking = monthCounts.map((c, idx) => ({n: idx, c, name: monthNames[idx]})).sort((a,b)=> b.c - a.c || a.n - b.n);
      monthRankingOl.innerHTML = '';
      const topMonthRanking = monthRanking.slice(0, topMonthsCount);
      topMonthRanking.forEach((r, idx) => {
        const li = document.createElement('li');
        li.textContent = `${idx+1}. ${r.name} ‚Üí ${r.c} vezes`;
        if(r.n === chosenMonth) li.className = "highlight";
        monthRankingOl.appendChild(li);
      });
    }

    function updateCloverUI() {
      const topCloversCount = parseInt(topCloversCountInput.value) || 1;
      const chosenClover = parseInt(chosenCloverSelect.value);
      const N = parseInt(cloverRecommendedNInput.value) || 0;
      cloverClicksSpan.textContent = cloverClicks;
      cloverStatusSpan.textContent = N > 0 ? (cloverClicks >= N ? '‚úÖ Amostragem suficiente' : '‚û°Ô∏è Continue at√© N') : '';

      const maxCloverCount = Math.max(1, ...cloverCounts);
      cloverFreqGrid.innerHTML = '';
      cloverCounts.forEach((c, idx) => {
        const div = document.createElement('div');
        div.className = 'freq';
        const highlight = chosenClover === -1 ? false : idx == chosenClover;
        div.innerHTML = `<div><b ${highlight ? 'class="highlight"' : ''}>${cloverNames[idx]}</b></div><div>${c}</div>`;
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.width = (c / maxCloverCount * 100) + '%';
        div.appendChild(bar);
        cloverFreqGrid.appendChild(div);
      });

      const cloverRanking = cloverCounts.map((c, idx) => ({n: idx, c, name: cloverNames[idx]})).sort((a,b)=> b.c - a.c || a.n - b.n);
      cloverRankingOl.innerHTML = '';
      const topCloverRanking = cloverRanking.slice(0, topCloversCount);
      topCloverRanking.forEach((r, idx) => {
        const li = document.createElement('li');
        li.textContent = `${idx+1}. ${r.name} ‚Üí ${r.c} vezes`;
        if(r.n === chosenClover) li.className = "highlight";
        cloverRankingOl.appendChild(li);
      });
    }

    function drawNumber() {
      if (!validateFixedNumbers()) return;
      const {min, max, k} = getRange();
      initCountsIfNeeded();
      const fixedNumbers = getFixedNumbers();
      const availableNumbers = [];
      for (let i = min; i <= max; i++) { if (!fixedNumbers.includes(i)) availableNumbers.push(i); }
      if (availableNumbers.length === 0) return;
      const randomIndex = Math.floor(Math.random() * availableNumbers.length);
      const drawnNumber = availableNumbers[randomIndex];
      counts[drawnNumber - min]++;
      clicks++;
      lastNumberDiv.textContent = drawnNumber;
      updateUI();
    }

    function drawMonth() { const drawnMonth = Math.floor(Math.random() * 12); monthCounts[drawnMonth]++; monthClicks++; updateMonthUI(); }

    function drawClovers() {
      const drawnClovers = [];
      while (drawnClovers.length < 2) {
        const drawnClover = Math.floor(Math.random() * 7);
        if (!drawnClovers.includes(drawnClover)) { drawnClovers.push(drawnClover); }
      }
      drawnClovers.forEach(cloverId => cloverCounts[cloverId]++);
      cloverClicks++;
      cloverElements.forEach(clover => clover.classList.remove('selected'));
      drawnClovers.forEach(cloverId => {
        const cloverEl = document.querySelector(`.clover[data-id="${cloverId}"]`);
        if (cloverEl) cloverEl.classList.add('selected');
      });
      updateCloverUI();
    }

    // Web Worker para sorteio de n√∫meros em segundo plano (corrigido: p√°ra automaticamente quando atingir N)
    function startNumberWorker() {
      if (numberWorker) return;
      const workerCode = `
        let intervalId = null;
        self.onmessage = function(e) {
          if (e.data === 'start') {
            if (intervalId) clearInterval(intervalId);
            intervalId = setInterval(() => { self.postMessage('draw'); }, 100);
          } else if (e.data === 'stop') {
            if (intervalId) { clearInterval(intervalId); intervalId = null; }
          }
        };
      `;
      const blob = new Blob([workerCode], { type: 'application/javascript' });
      const url = URL.createObjectURL(blob);
      numberWorker = new Worker(url);

      numberWorker.onmessage = function(e) {
        if (e.data === 'draw') {
          drawNumber();
          // Verifica se atingiu N recomendado e para automaticamente
          const N = parseInt(recommendedNInput.value) || 0;
          if (N > 0 && clicks >= N) {
            // Parar worker e atualizar UI
            stopAutoDraw();
          }
        }
      };
      numberWorker.postMessage('start');
    }

    function stopNumberWorker() {
      if (numberWorker) {
        try { numberWorker.postMessage('stop'); } catch (err) { /* worker j√° encerrado */ }
        numberWorker.terminate();
        numberWorker = null;
      }
    }

    // Web Worker meses (parar autom√°tico quando atingir N)
    function startMonthWorker() {
      if (monthWorker) return;
      const workerCode = `
        let intervalId = null;
        self.onmessage = function(e) {
          if (e.data === 'start') {
            if (intervalId) clearInterval(intervalId);
            intervalId = setInterval(() => { self.postMessage('draw'); }, 100);
          } else if (e.data === 'stop') {
            if (intervalId) { clearInterval(intervalId); intervalId = null; }
          }
        };
      `;
      const blob = new Blob([workerCode], { type: 'application/javascript' });
      const url = URL.createObjectURL(blob);
      monthWorker = new Worker(url);

      monthWorker.onmessage = function(e) {
        if (e.data === 'draw') {
          drawMonth();
          const N = parseInt(monthRecommendedNInput.value) || 0;
          if (N > 0 && monthClicks >= N) {
            stopMonthAutoDraw();
          }
        }
      };
      monthWorker.postMessage('start');
    }

    function stopMonthWorker() { if (monthWorker) { try { monthWorker.postMessage('stop'); } catch (err){} monthWorker.terminate(); monthWorker = null; } }

    // Web Worker trevos (parar autom√°tico quando atingir N)
    function startCloverWorker() {
      if (cloverWorker) return;
      const workerCode = `
        let intervalId = null;
        self.onmessage = function(e) {
          if (e.data === 'start') {
            if (intervalId) clearInterval(intervalId);
            intervalId = setInterval(() => { self.postMessage('draw'); }, 100);
          } else if (e.data === 'stop') {
            if (intervalId) { clearInterval(intervalId); intervalId = null; }
          }
        };
      `;
      const blob = new Blob([workerCode], { type: 'application/javascript' });
      const url = URL.createObjectURL(blob);
      cloverWorker = new Worker(url);

      cloverWorker.onmessage = function(e) {
        if (e.data === 'draw') {
          drawClovers();
          const N = parseInt(cloverRecommendedNInput.value) || 0;
          if (N > 0 && cloverClicks >= N) {
            stopCloverAutoDraw();
          }
        }
      };
      cloverWorker.postMessage('start');
    }

    function stopCloverWorker() { if (cloverWorker) { try { cloverWorker.postMessage('stop'); } catch (err){} cloverWorker.terminate(); cloverWorker = null; } }

    function startAutoDraw() {
      if (!validateFixedNumbers()) return;
      const N = parseInt(recommendedNInput.value) || 0;
      if (N <= 0) return;
      autoMode = true;
      drawBtn.disabled = true;
      autoBtn.style.display = 'none';
      stopAutoBtn.style.display = 'inline-block';
      startNumberWorker();
    }

    function stopAutoDraw() {
      autoMode = false;
      drawBtn.disabled = false;
      autoBtn.style.display = 'inline-block';
      stopAutoBtn.style.display = 'none';
      stopNumberWorker();
      updateUI();
    }

    function startMonthAutoDraw() {
      const N = parseInt(monthRecommendedNInput.value) || 0;
      if (N <= 0) return;
      monthAutoMode = true;
      drawMonthBtn.disabled = true;
      autoMonthBtn.style.display = 'none';
      stopAutoMonthBtn.style.display = 'inline-block';
      startMonthWorker();
    }

    function stopMonthAutoDraw() {
      monthAutoMode = false;
      drawMonthBtn.disabled = false;
      autoMonthBtn.style.display = 'inline-block';
      stopAutoMonthBtn.style.display = 'none';
      stopMonthWorker();
      updateMonthUI();
    }

    function startCloverAutoDraw() {
      const N = parseInt(cloverRecommendedNInput.value) || 0;
      if (N <= 0) return;
      cloverAutoMode = true;
      drawCloverBtn.disabled = true;
      autoCloverBtn.style.display = 'none';
      stopAutoCloverBtn.style.display = 'inline-block';
      startCloverWorker();
    }

    function stopCloverAutoDraw() {
      cloverAutoMode = false;
      drawCloverBtn.disabled = false;
      autoCloverBtn.style.display = 'inline-block';
      stopAutoCloverBtn.style.display = 'none';
      stopCloverWorker();
      updateCloverUI();
    }

    // Event Listeners
    drawBtn.onclick = drawNumber;
    autoBtn.onclick = startAutoDraw;
    stopAutoBtn.onclick = stopAutoDraw;
    resetBtn.onclick = resetCounts;

    drawMonthBtn.onclick = drawMonth;
    autoMonthBtn.onclick = startMonthAutoDraw;
    stopAutoMonthBtn.onclick = stopMonthAutoDraw;
    resetMonthBtn.onclick = resetMonthCounts;

    drawCloverBtn.onclick = drawClovers;
    autoCloverBtn.onclick = startCloverAutoDraw;
    stopAutoCloverBtn.onclick = stopCloverAutoDraw;
    resetCloverBtn.onclick = resetCloverCounts;

    [minValInput, maxValInput, topCountInput, epsilonInput, confidenceInput, fixedNumbersInput].forEach(el => { el.addEventListener('input', updateRecommendedN); });
    [topMonthsCountInput, monthEpsilonInput, monthConfidenceInput].forEach(el => { el.addEventListener('input', updateMonthRecommendedN); });
    [topCloversCountInput, cloverEpsilonInput, cloverConfidenceInput].forEach(el => { el.addEventListener('input', updateCloverRecommendedN); });

    // Inicializa√ß√£o
    updateRecommendedN();
    updateMonthRecommendedN();
    updateCloverRecommendedN();
    initCountsIfNeeded();
    updateUI();
    updateMonthUI();
    updateCloverUI();
  </script>
</body>
</html>
